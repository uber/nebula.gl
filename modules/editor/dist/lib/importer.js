"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parseImport = parseImport;

var _togeojson = require("@tmcw/togeojson");

var _core = require("@loaders.gl/core");

var _wkt = require("@loaders.gl/wkt");

/* eslint-env browser */
function shouldTryGeoJson(data) {
  return data.startsWith('{');
}

function shouldTryKml(data) {
  return data.startsWith('<');
}

function shouldTryWkt(data) {
  return data.startsWith('POINT') || data.startsWith('LINESTRING') || data.startsWith('POLYGON') || data.startsWith('MULTIPOINT') || data.startsWith('MULTILINESTRING') || data.startsWith('MULTIPOLYGON');
}

function getCleanedFeatures(geojson) {
  if (geojson.type !== 'FeatureCollection' && geojson.type !== 'Feature') {
    throw Error("GeoJSON must have type of 'Feature' or 'FeatureCollection'");
  }

  var features = geojson.type === 'FeatureCollection' ? geojson.features : [geojson];
  return features.map(getCleanedFeature);
}

function getCleanedFeature(feature) {
  var id = feature.id; // reduce null-checking

  var properties = feature.properties || {};
  var geometry = feature.geometry; // @ts-ignore

  if (geometry.type === 'GeometryCollection' && geometry.geometries.length === 1) {
    // There's only one geometry
    // @ts-ignore
    geometry = geometry.geometries[0]; // @ts-ignore
  } else if (geometry.type === 'GeometryCollection' && geometry.geometries.length > 1) {
    // @ts-ignore
    var types = new Set(geometry.geometries.map(function (g) {
      return g.type;
    }));

    if (types.size === 1) {
      // See if it can be combined into a Multi* geometry
      var type = types.values().next().value;

      if (type === 'Polygon') {
        // Combine all the Polygons into a single MultiPolygon
        geometry = {
          type: 'MultiPolygon',
          // @ts-ignore
          coordinates: geometry.geometries.map(function (g) {
            return g.coordinates;
          })
        };
      } else if (type === 'LineString') {
        // Combine all the LineStrings into a single MultiLineString
        geometry = {
          type: 'MultiLineString',
          // @ts-ignore
          coordinates: geometry.geometries.map(function (g) {
            return g.coordinates;
          })
        };
      }
    } else {
      // Mixed geometry types, we don't yet handle it
      throw Error('GeometryCollection geometry type not yet supported');
    }
  } // @ts-ignore


  return {
    type: 'Feature',
    id: id,
    geometry: geometry,
    properties: properties
  };
}

function parseImportString(data) {
  data = data.trim();
  var validData;
  var validationErrors = [];

  if (shouldTryGeoJson(data)) {
    // Parse as GeoJSON
    try {
      var parsed = JSON.parse(data);
      validData = {
        valid: true,
        type: 'GeoJSON',
        features: getCleanedFeatures(parsed)
      };
    } catch (err) {
      validationErrors.push('Error parsing GeoJSON');
      validationErrors.push(err.toString());
    }
  } else if (shouldTryKml(data)) {
    // Parse as KML
    var xml = new DOMParser().parseFromString(data, 'text/xml');

    try {
      var _parsed = (0, _togeojson.kml)(xml);
      /*
      TODO: Revisit using loaders.gl/kml for this later
      const parsed_ = parseSync(data, KMLasGeoJsonLoader);
      // This is changing the coordinates to floats, because in loaders.gl/kml 2.1.1 they are returned as strings.
      const parsed = {
        ...parsed_,
        features: parsed_.features.map(f => ({
          ...f,
          geometry: {
            ...f.geometry,
            coordinates: f.geometry.coordinates.map(coords => coords.map(triple => triple.map(s => Number.parseFloat(s))))
          }
        }))
      };
      */


      var isFeature = _parsed && _parsed.type === 'Feature';
      var isFeatureCollectionWithFeatures = _parsed && _parsed.type === 'FeatureCollection' && _parsed.features.length > 0;
      var isValid = isFeature || isFeatureCollectionWithFeatures;

      if (isValid) {
        validData = {
          valid: true,
          type: 'KML',
          features: getCleanedFeatures(_parsed)
        };
      } else {
        validationErrors.push('Invalid KML');
      }
    } catch (err) {
      validationErrors.push('Error parsing KML');
      validationErrors.push(err.toString());
    }
  } else if (shouldTryWkt(data)) {
    try {
      var _parsed2 = (0, _core.parseSync)(data, _wkt.WKTLoader);

      if (_parsed2) {
        validData = {
          valid: true,
          type: 'WKT',
          features: [{
            type: 'Feature',
            properties: {},
            geometry: _parsed2
          }]
        };
      } else {
        validationErrors.push('Invalid WKT');
      }
    } catch (err) {
      validationErrors.push('Error parsing WKT');
      validationErrors.push(err.toString());
    }
  } else {
    validationErrors.push('Unknown data format');
  }

  if (validData) {
    return Promise.resolve(validData);
  }

  return Promise.resolve({
    valid: false,
    validationErrors: validationErrors
  });
}

function parseImportFile(file) {
  return new Promise(function (resolve, reject) {
    var reader = new FileReader();

    reader.onload = function () {
      var fileAsString = reader.result;
      resolve(parseImportString(fileAsString));
    };

    reader.onabort = function () {
      reject(Error('file reading was aborted'));
    };

    reader.onerror = function () {
      reject(Error('file reading has failed'));
    };

    reader.readAsText(file);
  });
}

function parseImport(data) {
  if (typeof data === 'string') {
    return parseImportString(data);
  }

  return parseImportFile(data);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvaW1wb3J0ZXIudHMiXSwibmFtZXMiOlsic2hvdWxkVHJ5R2VvSnNvbiIsImRhdGEiLCJzdGFydHNXaXRoIiwic2hvdWxkVHJ5S21sIiwic2hvdWxkVHJ5V2t0IiwiZ2V0Q2xlYW5lZEZlYXR1cmVzIiwiZ2VvanNvbiIsInR5cGUiLCJFcnJvciIsImZlYXR1cmVzIiwibWFwIiwiZ2V0Q2xlYW5lZEZlYXR1cmUiLCJmZWF0dXJlIiwiaWQiLCJwcm9wZXJ0aWVzIiwiZ2VvbWV0cnkiLCJnZW9tZXRyaWVzIiwibGVuZ3RoIiwidHlwZXMiLCJTZXQiLCJnIiwic2l6ZSIsInZhbHVlcyIsIm5leHQiLCJ2YWx1ZSIsImNvb3JkaW5hdGVzIiwicGFyc2VJbXBvcnRTdHJpbmciLCJ0cmltIiwidmFsaWREYXRhIiwidmFsaWRhdGlvbkVycm9ycyIsInBhcnNlZCIsIkpTT04iLCJwYXJzZSIsInZhbGlkIiwiZXJyIiwicHVzaCIsInRvU3RyaW5nIiwieG1sIiwiRE9NUGFyc2VyIiwicGFyc2VGcm9tU3RyaW5nIiwiaXNGZWF0dXJlIiwiaXNGZWF0dXJlQ29sbGVjdGlvbldpdGhGZWF0dXJlcyIsImlzVmFsaWQiLCJXS1RMb2FkZXIiLCJQcm9taXNlIiwicmVzb2x2ZSIsInBhcnNlSW1wb3J0RmlsZSIsImZpbGUiLCJyZWplY3QiLCJyZWFkZXIiLCJGaWxlUmVhZGVyIiwib25sb2FkIiwiZmlsZUFzU3RyaW5nIiwicmVzdWx0Iiwib25hYm9ydCIsIm9uZXJyb3IiLCJyZWFkQXNUZXh0IiwicGFyc2VJbXBvcnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7QUFFQTs7QUFDQTs7QUFMQTtBQXlCQSxTQUFTQSxnQkFBVCxDQUEwQkMsSUFBMUIsRUFBaUQ7QUFDL0MsU0FBT0EsSUFBSSxDQUFDQyxVQUFMLENBQWdCLEdBQWhCLENBQVA7QUFDRDs7QUFFRCxTQUFTQyxZQUFULENBQXNCRixJQUF0QixFQUE2QztBQUMzQyxTQUFPQSxJQUFJLENBQUND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Q0FBQ3hDLEtBQUssQ0FBQyx5QkFBRCxDQUFOLENBQU47QUFDRCxLQUZEOztBQUlBeUMsSUFBQUEsTUFBTSxDQUFDTyxVQUFQLENBQWtCVCxJQUFsQjtBQUNELEdBZE0sQ0FBUDtBQWVEOztBQUVNLFNBQVNVLFdBQVQsQ0FBcUJ4RCxJQUFyQixFQUErRDtBQUNwRSxNQUFJLE9BQU9BLElBQVAsS0FBZ0IsUUFBcEIsRUFBOEI7QUFDNUIsV0FBT3lCLGlCQUFpQixDQUFDekIsSUFBRCxDQUF4QjtBQUNEOztBQUNELFNBQU82QyxlQUFlLENBQUM3QyxJQUFELENBQXRCO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZW52IGJyb3dzZXIgKi9cblxuaW1wb3J0IHsga21sIH0gZnJvbSAnQHRtY3cvdG9nZW9qc29uJztcblxuaW1wb3J0IHsgcGFyc2VTeW5jIH0gZnJvbSAnQGxvYWRlcnMuZ2wvY29yZSc7XG5pbXBvcnQgeyBXS1RMb2FkZXIgfSBmcm9tICdAbG9hZGVycy5nbC93a3QnO1xuXG4vLyBJZiB3ZSB3YW50IHRvIHN1cHBvcnQgbm9kZSAtLSB3ZSBuZWVkIHRvIGltcG9ydCB4bWxkb20uXG4vLyBGb3Igbm93LCB3ZSdyZSBvbmx5IHN1cHBvcnRpbmcgYnJvd3NlciBzbyB3ZSBjYW4gbGVhdmUgaXQgb3V0LlxuLy8gaW1wb3J0IHsgRE9NUGFyc2VyIH0gZnJvbSAneG1sZG9tJztcbmltcG9ydCB7IEFueUdlb0pzb24sIEZlYXR1cmUgfSBmcm9tICdAbmVidWxhLmdsL2VkaXQtbW9kZXMnO1xuXG5leHBvcnQgdHlwZSBWYWxpZEltcG9ydERhdGEgPSB7XG4gIHZhbGlkOiB0cnVlO1xuICB0eXBlOiAnR2VvSlNPTicgfCAnS01MJyB8ICdXS1QnO1xuICBmZWF0dXJlczogRmVhdHVyZVtdO1xufTtcblxuZXhwb3J0IHR5cGUgSW52YWxpZEltcG9ydERhdGEgPSB7XG4gIHZhbGlkOiBmYWxzZTtcbiAgdmFsaWRhdGlvbkVycm9yczogc3RyaW5nW107XG59O1xuXG5leHBvcnQgdHlwZSBJbXBvcnREYXRhID0gVmFsaWRJbXBvcnREYXRhIHwgSW52YWxpZEltcG9ydERhdGE7XG5cbmZ1bmN0aW9uIHNob3VsZFRyeUdlb0pzb24oZGF0YTogc3RyaW5nKTogYm9vbGVhbiB7XG4gIHJldHVybiBkYXRhLnN0YXJ0c1dpdGgoJ3snKTtcbn1cblxuZnVuY3Rpb24gc2hvdWxkVHJ5S21sKGRhdGE6IHN0cmluZyk6IGJvb2xlYW4ge1xuICByZXR1cm4gZGF0YS5zdGFydHNXaXRoKCc8Jyk7XG59XG5cbmZ1bmN0aW9uIHNob3VsZFRyeVdrdChkYXRhOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgcmV0dXJuIChcbiAgICBkYXRhLnN0YXJ0c1dpdGgoJ1BPSU5UJykgfHxcbiAgICBkYXRhLnN0YXJ0c1dpdGgoJ0xJTkVTVFJJTkcnKSB8fFxuICAgIGRhdGEuc3RhcnRzV2l0aCgnUE9MWUdPTicpIHx8XG4gICAgZGF0YS5zdGFydHNXaXRoKCdNVUxUSVBPSU5UJykgfHxcbiAgICBkYXRhLnN0YXJ0c1dpdGgoJ01VTFRJTElORVNUUklORycpIHx8XG4gICAgZGF0YS5zdGFydHNXaXRoKCdNVUxUSVBPTFlHT04nKVxuICApO1xufVxuXG5mdW5jdGlvbiBnZXRDbGVhbmVkRmVhdHVyZXMoZ2VvanNvbjogQW55R2VvSnNvbik6IEZlYXR1cmVbXSB7XG4gIGlmIChnZW9qc29uLnR5cGUgIT09ICdGZWF0dXJlQ29sbGVjdGlvbicgJiYgZ2VvanNvbi50eXBlICE9PSAnRmVhdHVyZScpIHtcbiAgICB0aHJvdyBFcnJvcihgR2VvSlNPTiBtdXN0IGhhdmUgdHlwZSBvZiAnRmVhdHVyZScgb3IgJ0ZlYXR1cmVDb2xsZWN0aW9uJ2ApO1xuICB9XG5cbiAgY29uc3QgZmVhdHVyZXM6IEZlYXR1cmVbXSA9IGdlb2pzb24udHlwZSA9PT0gJ0ZlYXR1cmVDb2xsZWN0aW9uJyA/IGdlb2pzb24uZmVhdHVyZXMgOiBbZ2VvanNvbl07XG5cbiAgcmV0dXJuIGZlYXR1cmVzLm1hcChnZXRDbGVhbmVkRmVhdHVyZSk7XG59XG5cbmZ1bmN0aW9uIGdldENsZWFuZWRGZWF0dXJlKGZlYXR1cmU6IEZlYXR1cmUpOiBGZWF0dXJlIHtcbiAgY29uc3QgeyBpZCB9ID0gZmVhdHVyZTtcbiAgLy8gcmVkdWNlIG51bGwtY2hlY2tpbmdcbiAgY29uc3QgcHJvcGVydGllcyA9IGZlYXR1cmUucHJvcGVydGllcyB8fCB7fTtcblxuICBsZXQgZ2VvbWV0cnkgPSBmZWF0dXJlLmdlb21ldHJ5O1xuICAvLyBAdHMtaWdub3JlXG4gIGlmIChnZW9tZXRyeS50eXBlID09PSAnR2VvbWV0cnlDb2xsZWN0aW9uJyAmJiBnZW9tZXRyeS5nZW9tZXRyaWVzLmxlbmd0aCA9PT0gMSkge1xuICAgIC8vIFRoZXJlJ3Mgb25seSBvbmUgZ2VvbWV0cnlcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgZ2VvbWV0cnkgPSBnZW9tZXRyeS5nZW9tZXRyaWVzWzBdO1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgfSBlbHNlIGlmIChnZW9tZXRyeS50eXBlID09PSAnR2VvbWV0cnlDb2xsZWN0aW9uJyAmJiBnZW9tZXRyeS5nZW9tZXRyaWVzLmxlbmd0aCA+IDEpIHtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgY29uc3QgdHlwZXMgPSBuZXcgU2V0KGdlb21ldHJ5Lmdlb21ldHJpZXMubWFwKChnKSA9PiBnLnR5cGUpKTtcbiAgICBpZiAodHlwZXMuc2l6ZSA9PT0gMSkge1xuICAgICAgLy8gU2VlIGlmIGl0IGNhbiBiZSBjb21iaW5lZCBpbnRvIGEgTXVsdGkqIGdlb21ldHJ5XG4gICAgICBjb25zdCB0eXBlID0gdHlwZXMudmFsdWVzKCkubmV4dCgpLnZhbHVlO1xuICAgICAgaWYgKHR5cGUgPT09ICdQb2x5Z29uJykge1xuICAgICAgICAvLyBDb21iaW5lIGFsbCB0aGUgUG9seWdvbnMgaW50byBhIHNpbmdsZSBNdWx0aVBvbHlnb25cbiAgICAgICAgZ2VvbWV0cnkgPSB7XG4gICAgICAgICAgdHlwZTogJ011bHRpUG9seWdvbicsXG4gICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgIGNvb3JkaW5hdGVzOiBnZW9tZXRyeS5nZW9tZXRyaWVzLm1hcCgoZykgPT4gZy5jb29yZGluYXRlcyksXG4gICAgICAgIH07XG4gICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdMaW5lU3RyaW5nJykge1xuICAgICAgICAvLyBDb21iaW5lIGFsbCB0aGUgTGluZVN0cmluZ3MgaW50byBhIHNpbmdsZSBNdWx0aUxpbmVTdHJpbmdcbiAgICAgICAgZ2VvbWV0cnkgPSB7XG4gICAgICAgICAgdHlwZTogJ011bHRpTGluZVN0cmluZycsXG4gICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgIGNvb3JkaW5hdGVzOiBnZW9tZXRyeS5nZW9tZXRyaWVzLm1hcCgoZykgPT4gZy5jb29yZGluYXRlcyksXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIE1peGVkIGdlb21ldHJ5IHR5cGVzLCB3ZSBkb24ndCB5ZXQgaGFuZGxlIGl0XG4gICAgICB0aHJvdyBFcnJvcignR2VvbWV0cnlDb2xsZWN0aW9uIGdlb21ldHJ5IHR5cGUgbm90IHlldCBzdXBwb3J0ZWQnKTtcbiAgICB9XG4gIH1cblxuICAvLyBAdHMtaWdub3JlXG4gIHJldHVybiB7XG4gICAgdHlwZTogJ0ZlYXR1cmUnLFxuICAgIGlkLFxuICAgIGdlb21ldHJ5LFxuICAgIHByb3BlcnRpZXMsXG4gIH07XG59XG5cbmZ1bmN0aW9uIHBhcnNlSW1wb3J0U3RyaW5nKGRhdGE6IHN0cmluZyk6IFByb21pc2U8SW1wb3J0RGF0YT4ge1xuICBkYXRhID0gZGF0YS50cmltKCk7XG4gIGxldCB2YWxpZERhdGE6IFZhbGlkSW1wb3J0RGF0YSB8IG51bGwgfCB1bmRlZmluZWQ7XG4gIGNvbnN0IHZhbGlkYXRpb25FcnJvcnM6IHN0cmluZ1tdID0gW107XG4gIGlmIChzaG91bGRUcnlHZW9Kc29uKGRhdGEpKSB7XG4gICAgLy8gUGFyc2UgYXMgR2VvSlNPTlxuICAgIHRyeSB7XG4gICAgICBjb25zdCBwYXJzZWQgPSBKU09OLnBhcnNlKGRhdGEpO1xuICAgICAgdmFsaWREYXRhID0ge1xuICAgICAgICB2YWxpZDogdHJ1ZSxcbiAgICAgICAgdHlwZTogJ0dlb0pTT04nLFxuICAgICAgICBmZWF0dXJlczogZ2V0Q2xlYW5lZEZlYXR1cmVzKHBhcnNlZCksXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdmFsaWRhdGlvbkVycm9ycy5wdXNoKCdFcnJvciBwYXJzaW5nIEdlb0pTT04nKTtcbiAgICAgIHZhbGlkYXRpb25FcnJvcnMucHVzaChlcnIudG9TdHJpbmcoKSk7XG4gICAgfVxuICB9IGVsc2UgaWYgKHNob3VsZFRyeUttbChkYXRhKSkge1xuICAgIC8vIFBhcnNlIGFzIEtNTFxuICAgIGNvbnN0IHhtbCA9IG5ldyBET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcoZGF0YSwgJ3RleHQveG1sJyk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcGFyc2VkID0ga21sKHhtbCk7XG5cbiAgICAgIC8qXG4gICAgICBUT0RPOiBSZXZpc2l0IHVzaW5nIGxvYWRlcnMuZ2wva21sIGZvciB0aGlzIGxhdGVyXG4gICAgICBjb25zdCBwYXJzZWRfID0gcGFyc2VTeW5jKGRhdGEsIEtNTGFzR2VvSnNvbkxvYWRlcik7XG4gICAgICAvLyBUaGlzIGlzIGNoYW5naW5nIHRoZSBjb29yZGluYXRlcyB0byBmbG9hdHMsIGJlY2F1c2UgaW4gbG9hZGVycy5nbC9rbWwgMi4xLjEgdGhleSBhcmUgcmV0dXJuZWQgYXMgc3RyaW5ncy5cbiAgICAgIGNvbnN0IHBhcnNlZCA9IHtcbiAgICAgICAgLi4ucGFyc2VkXyxcbiAgICAgICAgZmVhdHVyZXM6IHBhcnNlZF8uZmVhdHVyZXMubWFwKGYgPT4gKHtcbiAgICAgICAgICAuLi5mLFxuICAgICAgICAgIGdlb21ldHJ5OiB7XG4gICAgICAgICAgICAuLi5mLmdlb21ldHJ5LFxuICAgICAgICAgICAgY29vcmRpbmF0ZXM6IGYuZ2VvbWV0cnkuY29vcmRpbmF0ZXMubWFwKGNvb3JkcyA9PiBjb29yZHMubWFwKHRyaXBsZSA9PiB0cmlwbGUubWFwKHMgPT4gTnVtYmVyLnBhcnNlRmxvYXQocykpKSlcbiAgICAgICAgICB9XG4gICAgICAgIH0pKVxuICAgICAgfTtcbiAgICAgICovXG4gICAgICBjb25zdCBpc0ZlYXR1cmUgPSBwYXJzZWQgJiYgcGFyc2VkLnR5cGUgPT09ICdGZWF0dXJlJztcbiAgICAgIGNvbnN0IGlzRmVhdHVyZUNvbGxlY3Rpb25XaXRoRmVhdHVyZXMgPVxuICAgICAgICBwYXJzZWQgJiYgcGFyc2VkLnR5cGUgPT09ICdGZWF0dXJlQ29sbGVjdGlvbicgJiYgcGFyc2VkLmZlYXR1cmVzLmxlbmd0aCA+IDA7XG4gICAgICBjb25zdCBpc1ZhbGlkID0gaXNGZWF0dXJlIHx8IGlzRmVhdHVyZUNvbGxlY3Rpb25XaXRoRmVhdHVyZXM7XG4gICAgICBpZiAoaXNWYWxpZCkge1xuICAgICAgICB2YWxpZERhdGEgPSB7XG4gICAgICAgICAgdmFsaWQ6IHRydWUsXG4gICAgICAgICAgdHlwZTogJ0tNTCcsXG4gICAgICAgICAgZmVhdHVyZXM6IGdldENsZWFuZWRGZWF0dXJlcyhwYXJzZWQpLFxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFsaWRhdGlvbkVycm9ycy5wdXNoKCdJbnZhbGlkIEtNTCcpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdmFsaWRhdGlvbkVycm9ycy5wdXNoKCdFcnJvciBwYXJzaW5nIEtNTCcpO1xuICAgICAgdmFsaWRhdGlvbkVycm9ycy5wdXNoKGVyci50b1N0cmluZygpKTtcbiAgICB9XG4gIH0gZWxzZSBpZiAoc2hvdWxkVHJ5V2t0KGRhdGEpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHBhcnNlZCA9IHBhcnNlU3luYyhkYXRhLCBXS1RMb2FkZXIpO1xuICAgICAgaWYgKHBhcnNlZCkge1xuICAgICAgICB2YWxpZERhdGEgPSB7XG4gICAgICAgICAgdmFsaWQ6IHRydWUsXG4gICAgICAgICAgdHlwZTogJ1dLVCcsXG4gICAgICAgICAgZmVhdHVyZXM6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgdHlwZTogJ0ZlYXR1cmUnLFxuICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiB7fSxcbiAgICAgICAgICAgICAgZ2VvbWV0cnk6IHBhcnNlZCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhbGlkYXRpb25FcnJvcnMucHVzaCgnSW52YWxpZCBXS1QnKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHZhbGlkYXRpb25FcnJvcnMucHVzaCgnRXJyb3IgcGFyc2luZyBXS1QnKTtcbiAgICAgIHZhbGlkYXRpb25FcnJvcnMucHVzaChlcnIudG9TdHJpbmcoKSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHZhbGlkYXRpb25FcnJvcnMucHVzaCgnVW5rbm93biBkYXRhIGZvcm1hdCcpO1xuICB9XG5cbiAgaWYgKHZhbGlkRGF0YSkge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodmFsaWREYXRhKTtcbiAgfVxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICB2YWxpZDogZmFsc2UsXG4gICAgdmFsaWRhdGlvbkVycm9ycyxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHBhcnNlSW1wb3J0RmlsZShmaWxlOiBGaWxlKTogUHJvbWlzZTxJbXBvcnREYXRhPiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcbiAgICByZWFkZXIub25sb2FkID0gKCkgPT4ge1xuICAgICAgY29uc3QgZmlsZUFzU3RyaW5nOiBhbnkgPSByZWFkZXIucmVzdWx0O1xuICAgICAgcmVzb2x2ZShwYXJzZUltcG9ydFN0cmluZyhmaWxlQXNTdHJpbmcpKTtcbiAgICB9O1xuICAgIHJlYWRlci5vbmFib3J0ID0gKCkgPT4ge1xuICAgICAgcmVqZWN0KEVycm9yKCdmaWxlIHJlYWRpbmcgd2FzIGFib3J0ZWQnKSk7XG4gICAgfTtcbiAgICByZWFkZXIub25lcnJvciA9ICgpID0+IHtcbiAgICAgIHJlamVjdChFcnJvcignZmlsZSByZWFkaW5nIGhhcyBmYWlsZWQnKSk7XG4gICAgfTtcblxuICAgIHJlYWRlci5yZWFkQXNUZXh0KGZpbGUpO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlSW1wb3J0KGRhdGE6IHN0cmluZyB8IEZpbGUpOiBQcm9taXNlPEltcG9ydERhdGE+IHtcbiAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiBwYXJzZUltcG9ydFN0cmluZyhkYXRhKTtcbiAgfVxuICByZXR1cm4gcGFyc2VJbXBvcnRGaWxlKGRhdGEpO1xufVxuIl19